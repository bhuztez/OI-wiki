%extends("templates/base.html")
%require(entry)

%(
is_home = urls.current_url() == urls.build("wiki", {"slug": "index"})
)

%def title():
%entry["title"]
%end

%def footer():
<div class="row">
<div class="col l5">
本页面的全部内容在 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh">CC BY-SA 4.0</a> 和 <a href="https://github.com/zTrix/sata-license">SATA</a> 协议之条款下提供，附加条款亦可能应用
</div>
%(
authors = db.select(
'''
SELECT author.*
FROM source AS author, json_each(author.metadata, '$.emails')
WHERE json_extract(author.metadata, '$.type') = 'author'
AND json_each.value IN (SELECT value FROM json_each({}))
''',
json.dumps(entry["authors"]))
author_emails = [email for author in authors for email in author["emails"]]
)

%if entry["authors"]:
<div class="col l3">
<h5>本页面贡献者</h5>
<ul>
%for author in authors:
<li><a class="grey-text text-lighten-3" href="%urls.build('author', {'slug': author['slug']})">%author["name"]</a></li>
%end
%for author in entry["authors"]:
%if author not in author_emails:
<li>%author</li>
%( warn(f"{entry.filename}: author {author!r} not found") )
%end
%end
</ul>
</div>
%end

<div class="col l3">
<h5>链接</h5>
<ul>
<li><a class="grey-text text-lighten-3" href="https://github.com/OI-wiki/OI-wiki/commits/master/%entry.filename">更新历史</a></li>
<li><a class="grey-text text-lighten-3" href="https://github.com/OI-wiki/OI-wiki/blob/master/%entry.filename">在 GitHub 上编辑此页！</a></li>
</ul>
</div>

</div>
%end


%def content():
<div class="md-content">
<div class="md-content__inner">
<article class="md-typeset">
%if not is_home:
<h1>%title()</h1>
%end

%if entry.get("canonical", None) is not None:
%(
canonical = db.get("""
SELECT wiki.*
FROM source AS wiki
WHERE json_extract(wiki.metadata, '$.type') = 'wiki'
AND json_extract(wiki.metadata, '$.slug') = {}
""", entry["canonical"])
)
<h4>Source:</h4>
<a href="%urls.build('wiki', {'slug': canonical['slug']})">%canonical["title"]</a>
%end

%(
canonicals = db.select("""
SELECT wiki.*
FROM source AS wiki
WHERE json_extract(wiki.metadata, '$.type') = 'wiki'
AND json_extract(wiki.metadata, '$.canonical') = {}
""", entry["slug"])
)

%if canonicals:
<h4>Canonicals</h4>
<ul>
%for canonical in canonicals:
<a href="%urls.build('wiki', {'slug': canonical['slug']})">%canonical["title"]</a>
%end
</ul>
%end

%entry.content
</article>

%(
pages = db.select("""
SELECT wiki.*
FROM source AS wiki
WHERE json_extract(wiki.metadata, '$.type') = 'wiki'
AND {} IN (SELECT value FROM json_each(wiki.metadata, '$.tags'))
""", entry["slug"])

tags = db.select(
'''
SELECT tag.*
FROM json_each({}) as tags
JOIN source as tag
ON tags.value = json_extract(tag.metadata, '$.slug')
AND json_extract(tag.metadata, '$.type') = 'wiki'
''',
json.dumps(entry["tags"]))
tag_slugs = [tag["slug"] for tag in tags]
)

<p>
%if pages:
<a class="btn" href="%urls.build('tagged', {'slug': entry['slug']})">%entry["title"]</a>
%end
%for tag in tags:
<a class="btn" href="%urls.build('tagged', {'slug': tag['slug']})">%tag["title"]</a>
%end
%for tag in entry["tags"]:
%if tag not in tag_slugs:
<span class="btn">%tag</span>
%( warn(f"{entry.filename}: tag {tag!r} not found") )
%end
%end
</p>
</div>
</div>

<div class="md-sidebar md-sidebar--secondary" data-md-state="lock">
<div class="md-nav">
<span class="md-nav__title">Table of contents</span>
<ul class="md-nav__list">
%for token in entry.content.toc_tokens:
<li class="md-nav__item"><a class="md-nav__link" href="#%token["id"]">%token["name"]</a></li>
%end
</ul>
</div>
</div>

%end
